<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReWear - Register Product</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .category-dropdown:hover .category-menu { display: block; }
        .category-dropdown:focus-within .category-menu { display: block; }
        .nav-link:hover { color: #4f46e5; }
        #previewContainer { min-height: 200px; }
        .dropzone { border: 2px dashed #d1d5db; transition: all 0.3s ease; }
        .dropzone-active { border-color: #4f46e5; background-color: #f0f7ff; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <!-- Logo -->
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <i class="fas fa-tshirt text-indigo-600 text-2xl mr-2"></i>
                        <span class="text-xl font-bold text-indigo-600">ReWear</span>
                    </a>
                    
                    <!-- Primary Nav -->
                    <div class="hidden sm:ml-8 sm:flex sm:space-x-8">
                        <!-- 중고거래 드롭다운 -->
                        <div class="category-dropdown relative">
                            <button class="nav-link text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium hover:border-indigo-500">
                                Marketplace
                                <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <!-- 드롭다운 메뉴 (너가 준 코드 그대로, 아이콘 추천만 바꿔줌) -->
                            <div class="category-menu absolute left-0 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                            <div class="py-1 grid grid-cols-2 gap-2 p-3">
                                <a href="market.html?category=T-Shirts" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-tshirt mr-2 text-indigo-400"></i> T-Shirts
                                </a>
                                <a href="market.html?category=Shirts/Blouses" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-shirt mr-2 text-purple-400"></i> Shirts<br>Blouses
                                </a>
                                <a href="market.html?category=Knit/Sweater" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-snowflake mr-2 text-blue-400"></i> Knit<br>Sweater
                                </a>
                                <a href="market.html?category=Outerwear/Jacket" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-user-tie mr-2 text-green-400"></i> Outerwear<br>Jacket
                                </a>
                                <a href="market.html?category=Pants/Denim" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-user-astronaut mr-2 text-yellow-400"></i> Pants<br>Denim
                                </a>
                                <a href="market.html?category=Skirts/Dresses" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-female mr-2 text-red-400"></i> Skirts<br>Dresses
                                </a>
                                <a href="market.html?category=Underwear/Socks" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-socks mr-2 text-pink-400"></i> Underwear<br>Socks
                                </a>
                                <a href="market.html?category=Accessories" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center">
                                <i class="fas fa-hat-cowboy mr-2 text-gray-400"></i> Accessories
                                </a>
                            </div>
                            </div>

                        </div>
                        <a href="sell.html" class="nav-link text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium hover:border-indigo-500">
                            Sell
                        </a>
                        <a href="chat.html" class="nav-link text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium hover:border-indigo-500">
                            Chat
                        </a>
                        <a href="tryon.html" class="nav-link text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 border-indigo-500 text-sm font-medium hover:border-indigo-500">
                            Virtual Try On
                        </a>
                    </div>
                </div>
                                
                <!-- Right Nav -->
                <div class="hidden sm:ml-6 sm:flex sm:items-center" id="nav-auth-buttons">
                    <button class="text-gray-700 px-3 py-1 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-50">
                        <a href="login.html">Login</a>
                    </button>
                    <button class="ml-3 bg-indigo-600 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-700">
                        <a href="register.html">Sign Up</a>
                    </button>
                </div>

                <!-- 추가: 로그인 후 표시될 내 정보/로그아웃 버튼 -->
                <div class="hidden sm:ml-6 sm:flex sm:items-center" id="nav-user-buttons" style="display:none;">
                    <span id="nav-user-name" class="text-gray-700 font-semibold text-sm"></span>
                    <button id="logout-btn" class="ml-3 text-gray-700 px-3 py-1 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-50">
                        Logout
                    </button>
                </div>
                                
                <!-- Mobile menu button -->
                <div class="-mr-2 flex items-center sm:hidden">
                    <button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
                
        <!-- Mobile menu -->
        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="pt-2 pb-3 space-y-1">
                <a href="market.html" class="block pl-3 pr-4 py-2 border-l-4 border-indigo-500 text-base font-medium text-indigo-700 bg-indigo-50">Marketplace</a>
                <a href="sell.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300">Sell</a>
                <a href="chat.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300">Chat</a>
                <a href="tryon.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300">Virtual Try On</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center mb-12">
            <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">
                Register Product
            </h1>
            <p class="mt-3 max-w-2xl mx-auto text-gray-500 sm:mt-4">
                Please enter the product information in detail. The more accurate the information, the faster it will be sold.
            </p>
        </div>
            <!-- Product Form -->
            <form class="divide-y divide-gray-200" id="tryon-form">

                <!-- Clothing Image Upload -->
                <div class="px-6 py-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Clothing Image</h3>
                        <p class="mt-1 text-sm text-gray-500">Upload the clothing image. (1 image only)</p>
                    </div>
                    <div class="mt-6">
                        <div id="clothing-dropzone" class="dropzone flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div id="clothing-initial" class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600 justify-center">
                                    <label for="clothing-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                        <span>Upload Photo</span>
                                        <input id="clothing-upload" name="clothing" type="file" class="sr-only" accept="image/*">
                                    </label>
                                    <p class="pl-1">or drag & drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                            <div id="clothing-preview" class="w-full flex justify-center items-center"></div>
                        </div>
                        <p id="clothing-error" class="mt-2 text-sm text-red-600 hidden"></p>
                    </div>
                </div>
                <!-- Avatar Image Upload (아바타도 동일하게 구조 적용) -->
                <div class="px-6 py-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Avatar Image</h3>
                        <p class="mt-1 text-sm text-gray-500">Upload the avatar image. (1 image only)</p>
                    </div>
                    <div class="mt-6">
                        <div id="avatar-dropzone" class="dropzone flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div id="avatar-initial" class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600 justify-center">
                                    <label for="avatar-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                        <span>Upload Photo</span>
                                        <input id="avatar-upload" name="avatar" type="file" class="sr-only" accept="image/*">
                                    </label>
                                    <p class="pl-1">or drag & drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                            <div id="avatar-preview" class="w-full flex justify-center items-center"></div>
                        </div>
                        <p id="avatar-error" class="mt-2 text-sm text-red-600 hidden"></p>
                    </div>
                </div>
                
                <!-- Register Button -->
                <div class="px-6 py-3 bg-gray-50 text-center">
                    <div id="result"></div>
                    <button type="submit"
                        class="bg-indigo-600 border border-transparent rounded-md shadow-sm py-2 px-4 inline-flex justify-center text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Try on
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer (한글 주석 유지) -->
    <footer class="bg-gray-800">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase">Marketplace</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">T-Shirts</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Shirts/Blouses</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Knit/Sweater</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Outerwear/Jacket</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase">Service</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Quality Check</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Sell</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Chat</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Terms of Use</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase">Support</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">FAQ</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Contact Us</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Announcements</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Shipping/Refund Policy</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase">Company</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">About Us</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Careers</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Brand Guide</a></li>
                        <li><a href="#" class="text-base text-gray-300 hover:text-white">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 md:flex md:items-center md:justify-between">
                <div class="flex space-x-6 md:order-2">
                    <a href="#" class="text-gray-400 hover:text-gray-300">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-gray-300">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-gray-300">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-gray-300">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
                <p class="mt-8 text-base text-gray-400 md:mt-0 md:order-1">
                    &copy; 2023 ReWear. All rights reserved.
                </p>
            </div>
        </div>
    </footer>

<!-- script 부분 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 모바일 메뉴 토글 등 기존 코드 그대로 두세요!
    const mobileMenuButton = document.querySelector('.sm\\:hidden button');
    const mobileMenu = document.getElementById('mobile-menu');
    mobileMenuButton.addEventListener('click', function() {
        const isHidden = mobileMenu.classList.contains('hidden');
        if(isHidden) {
            mobileMenu.classList.remove('hidden');
            mobileMenu.classList.add('block');
        } else {
            mobileMenu.classList.remove('block');
            mobileMenu.classList.add('hidden');
        }
    });

    function setupSingleImageUpload(dropzoneId, inputId, previewId, errorId, initialId) {
        const dropzone = document.getElementById(dropzoneId);
        const fileInput = document.getElementById(inputId);
        const previewContainer = document.getElementById(previewId);
        const errorBox = document.getElementById(errorId);
        const initial = document.getElementById(initialId);

        let file = null;
        const maxFileSize = 10 * 1024 * 1024;
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('dropzone-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('dropzone-active'), false);
        });
        dropzone.addEventListener('drop', function(e) { handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', function() { handleFiles(this.files); });

        function handleFiles(files) {
            errorBox.classList.add('hidden');
            if (files.length > 1) {
                showError('Only one image can be uploaded.');
                return;
            }
            const f = files[0];
            if (!allowedTypes.includes(f.type)) {
                showError('Only JPEG, PNG, and GIF images are allowed.');
                return;
            }
            if (f.size > maxFileSize) {
                showError('Only images up to 10MB are allowed.');
                return;
            }
            file = f;
            previewFile(f);
        }
        function previewFile(file) {
            // 기존 안내 요소 숨김
            if (initial) initial.style.display = "none";
            previewContainer.innerHTML = '';
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function() {
                const preview = document.createElement('div');
                preview.className = 'relative group w-full flex justify-center items-center';
                const img = document.createElement('img');
                img.src = reader.result;
                img.className = 'max-h-52 max-w-xs object-contain mx-auto rounded shadow';
                img.style.display = "block";
                img.style.margin = "0 auto";
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'absolute top-2 right-2 inline-flex items-center p-1 bg-red-500 rounded-full text-white opacity-0 group-hover:opacity-100 focus:outline-none';
                deleteBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                deleteBtn.addEventListener('click', function() {
                    file = null;
                    previewContainer.innerHTML = '';
                    fileInput.value = '';
                    if (initial) initial.style.display = "";
                });
                preview.appendChild(img);
                preview.appendChild(deleteBtn);
                previewContainer.appendChild(preview);
            };
        }
        function showError(message) {
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
        }
        return () => file;
    }
    // 각각의 드롭존 연결 (초기 안내 div id 넘김)
    window.getClothingFile = setupSingleImageUpload('clothing-dropzone', 'clothing-upload', 'clothing-preview', 'clothing-error', 'clothing-initial');
    window.getAvatarFile = setupSingleImageUpload('avatar-dropzone', 'avatar-upload', 'avatar-preview', 'avatar-error', 'avatar-initial');
});
</script>


<script type="module">
import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { auth, signOut, onAuthStateChanged } from "./js/firebase.js";

const navAuth = document.getElementById("nav-auth-buttons");
const navUser = document.getElementById("nav-user-buttons");
const navUserName = document.getElementById("nav-user-name");
const logoutBtn = document.getElementById("logout-btn");
const db = getFirestore();

// 네비게이션 유저 이름 토글
onAuthStateChanged(auth, async (user) => {
    if (user) {
        if (navAuth) navAuth.style.display = "none";
        if (navUser) navUser.style.display = "flex";
        if (navUserName) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                navUserName.textContent = userDoc.data().name || user.email || "User";
            } else {
                navUserName.textContent = user.email || "User";
            }
        }
    } else {
        if (navUser) navUser.style.display = "none";
        if (navAuth) navAuth.style.display = "flex";
    }
});

if (logoutBtn) {
    logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "index.html";
    };
}

// ----------- 옷입히기(try-on) 기능 -----------
function getSingleFile(fileGetterName) {
    return window[fileGetterName] ? window[fileGetterName]() : null;
}

document.getElementById('tryon-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const clothingFile = getSingleFile('getClothingFile');
    const avatarFile = getSingleFile('getAvatarFile');
    const resultBox = document.getElementById('result');
    resultBox.innerHTML = '';
    
    if (!clothingFile) {
        resultBox.innerHTML = '<div class="text-red-500">Please upload a clothing image.</div>';
        return;
    }
    if (!avatarFile) {
        resultBox.innerHTML = '<div class="text-red-500">Please upload an avatar image.</div>';
        return;
    }

    resultBox.innerHTML = `
        <div class="flex justify-center items-center flex-col">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-2"></div>
            <div class="text-gray-600">Processing, please wait...</div>
        </div>
    `;

    const formData = new FormData();
    formData.append('clothing', clothingFile);
    formData.append('avatar', avatarFile);

    try {
        const res = await fetch('http://175.214.92.162:811/try-on/', {
            method: 'POST',
            body: formData
        });
        if (!res.ok) throw new Error('Server Error');
        const data = await res.json();
        console.log(data);
        if (data && data.result_url) {
            const imageUrl = data.result_url.startsWith('http')
                ? data.result_url
                : `http://175.214.92.162:811${data.result_url}`;
            resultBox.innerHTML = `
                <div class="flex justify-center">
                    <img src="${imageUrl}" class="max-w-xs max-h-96 rounded shadow object-contain mx-auto" alt="Virtual Try-On Result">
                </div>
            `;
        } else {
            throw new Error('No result image received');
        }
    } catch (err) {
        resultBox.innerHTML = `<div class="text-red-500">Failed: ${err.message}</div>`;
    }
});
</script>


</body>
</html>
